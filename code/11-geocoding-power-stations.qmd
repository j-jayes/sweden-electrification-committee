---
title: "Geocoding power stations"
format: html
---

## Purpose

Geocoding the power stations

```{r}
library(tidyverse)
```

### Column names

```{r}
names <- tibble::tibble(
               column = c(1L,2L,3L,4L,5L,6L,
                          7L,8L,9L,10L,11L,12L,13L,14L,15L,16L,17L,18L,
                          19L,20L,21L),
        swedish_title = c("Nummer",
                          "Företagets namn","Kommun, stad","Kraftstationenes namn eller läge",
                          "Drivkraft","Utbyggd fallhöjd i m",
                          "Installerad generatoreffekt i kVA","Strömart","Periodtal",
                          "Spänningssysstem volt","Huvudtransformatorns effeckt kVA",
                          "Ortstransformatorernas antal",
                          "Ortstransformatorernas sammanlagda effekt kVA",
                          "Anslutning år 1922 motorer kW","belysning kW","övriga apparater kW",
                          "summa kW","Energiförbrukning år 1922 kWh",
                          "Elektriferad åkerareal den 1/1 1923 hektar","Anmärkningar","Nummer"),
        english_title = c("Number",
                          "The name of the company","Municipality, city",
                          "The name or mode of power station","Driving force",
                          "Expanded fall height in m","Installed generator power in KVA",
                          "Streaming","Period number","Voltage voltage",
                          "The effect of the main transformer",
                          "The number of local transformers","The total effect of the local transformers",
                          "Connection in 1922 engines KW","Lighting kw",
                          "Other appliances kW","Sum kw",
                          "Energy consumption in 1922 kWh","Electrified arable land on 1/1 1923 hectares",
                          "Notes","Number")
   )

```

### Geocoding

```{r}
df_gotland <- readxl::read_excel("data/Gotland_power_stations.xlsx") %>% 
  janitor::clean_names()

df_gotland <- df_gotland %>% 
  mutate(location_to_code = str_squish(str_remove(kraftstationenes_namn_eller_lage, " .*")),
         location_to_code = str_c(location_to_code, ", Gotland, Sweden"))
```

```{r}
library(tidygeocoder)

locations <- geocode(df_gotland, address = location_to_code)

locations %>% 
  filter(is.na(lat)) %>% 
  select(location_to_code)
```


Vallviks cementfabrik is at Valleviken when you look on the map.

### Blekinge

```{r}
library(googledrive)

drive_find(n_max = 10)

drive_download(file = "Blekinge_power stations", type = "csv")

df_blekinge <- read.csv("drive/Blekinge_power stations.csv") %>% 
  as_tibble()

df_blekinge %>% view()
```

### Uppsala

```{r}
df <- read_excel("ingest/uppsala_clean.xlsx")

# create manual lookup columns
df <- df %>%
  separate(coords_manual, 
           into = c("lat_manual", "long_manual"), 
           sep = ",", 
           convert = TRUE)

df <- df %>% 
  mutate(geocode_str = str_c(geocode_key, ", Uppsala, Sweden"))

library(tidygeocoder)

geocode_uppsala <- geocode(df, address = geocode_str, lat = "lat_osm", long = "long_osm")
```


```{r}
geocode_uppsala %>% 
  select(contains("long")) %>% view()

geocode_uppsala %>%
  ggplot(aes(long_osm, lat_osm, label = geocode_key)) +
  geom_point() +
  geom_label()
```

### Process

Basically I need to do a few things to get the geocoding down.

First I need to create a key - to look back to with the codes.

Then I need to do the geocoding with excel, because it will cut down on the time

Then I use tidygeocoder.

If they agree - we choose it.

If they disagree - we make a flag.

If neither return a result - we make a flag.

This will be done in the future, for now we want to have some results just for Uppsala.

It seems that the OSM lookup is way better than the one from Bing...

```{r}
geocode_uppsala <- geocode_uppsala %>% 
  mutate(lat = case_when(
    !is.na(lat_osm) ~ lat_osm,
    is.na(lat_osm) ~ lat_manual,
    is.na(lat_osm) & is.na(lat_manual) ~ NA_real_
  ),
  long = case_when(
    !is.na(long_osm) ~ long_osm,
    is.na(long_osm) ~ long_manual,
    is.na(long_osm) & is.na(long_manual) ~ NA_real_
  ))

geocode_uppsala <- geocode_uppsala %>% 
  select(geocode_key, long, lat)
```

